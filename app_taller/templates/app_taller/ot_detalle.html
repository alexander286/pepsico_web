{% extends "app_taller/base.html" %}
{% block content %}
<h2>OT #{{ ot.numero_ot }}</h2>


<!-- VISTA DEL SUPERVISOR AL ABRIR LA OTS-->
<div class="card">
  <div><b>Patente:</b> {{ ot.vehiculo.patente }}</div>
  <div><b>Marca:</b> {{ ot.vehiculo.marca|default:"‚Äî" }}</div>
  <div><b>Modelo:</b> {{ ot.vehiculo.modelo|default:"‚Äî" }}</div>
  <div><b>A√±o del modelo:</b> {{ ot.vehiculo.a√±o_modelo|default:"‚Äî" }}</div>
  <div><b>Chofer que registr√≥:</b> {{ ot.usuario_solicitante.nombre_completo|default:"‚Äî" }}</div>
  <div><b>Prioridad:</b> {{ ot.get_prioridad_display }}</div>
  <div><b>Estado del vehiculo:</b> {{ ot.vehiculo.get_estado_display }}</div>
  <div><b>Estado OT:</b> {{ ot.estado }}</div>
  <div><b>Mec√°nico asignado:</b> {{ ot.mecanico_asignado|default:"‚Äî" }}</div>
  <div><b>Taller:</b> {{ ot.taller.nombre }}</div>
  <div><b>Descripci√≥n:</b> {{ ot.descripcion_problema|default:"‚Äî" }}</div>
  <div><b>Apertura:</b> {{ ot.fecha_apertura }}</div>
</div>




<hr/>

<h3>Acciones</h3>

{# Solo supervisor / admin / jefe de taller #}
{% if soy_supervisor %}
<section class="card">
  <h3>Asignar mec√°nico</h3>
  <form method="post" action="{% url 'ot_asignar_mecanico' numero_ot=ot.numero_ot %}">
    {% csrf_token %}
    {{ form_asignar.mecanico }}
    <button class="btn btn-primary btn-sm" type="submit">Asignar mec√°nico</button>
  </form>
</section>

<section class="card">
  <h3>Cambiar estado</h3>
  <form method="post" action="{% url 'ot_cambiar_estado' numero_ot=ot.numero_ot %}">
    {% csrf_token %}
    {{ form_estado.nuevo_estado }}   {# <- este es el campo correcto #}
    {{ form_estado.motivo }}
    <button class="btn btn-sm" type="submit">Cambiar</button>
  </form>
</section>
{% endif %}



<h3>Prioridad</h3>
<form method="post" action="{% url 'ot_cambiar_prioridad' numero_ot=ot.numero_ot %}">
  {% csrf_token %}
  {{ form_prioridad.prioridad }}
  <button class="btn btn-sm btn-primary" type="submit">Actualizar</button>
</form>

<h3>Estado del veh√≠culo</h3>
<form method="post" action="{% url 'vehiculo_cambiar_estado' numero_ot=ot.numero_ot %}">
  {% csrf_token %}
  {{ form_estado_vehiculo.estado }}
  <button class="btn btn-sm btn-primary" type="submit">Actualizar</button>
</form>



<form method="post" action="{% url 'ot_cambiar_estado' ot.numero_ot %}">
  {% csrf_token %}
  <select name="nuevo_estado" class="form-control">
    {% for code,label in ESTADO_CHOICES %}
      <option value="{{ code }}" {% if ot.estado == code %}selected{% endif %}>{{ label }}</option>
    {% endfor %}
  </select>

  <textarea name="motivo" rows="2" class="form-control" placeholder="Motivo"></textarea>

  <button type="submit" class="btn btn-primary">Cambiar estado</button>
</form>


<!----------------------------->
<form method="post"
      action="{% url 'ot_subir_adjuntos' numero_ot=ot.numero_ot %}"
      enctype="multipart/form-data">
  {% csrf_token %}
  {{ form_adjuntos.etiqueta }}
  <input type="file" name="archivos" multiple accept=".jpg,.jpeg,.png,.pdf">
  <button class="btn btn-sm btn-primary" type="submit">Subir</button>
</form>

<!-- Debug opcional -->
<!-- DEBUG: adjuntos={{ adjuntos|length }} -->





<!----------------------------->


<!--------------SECICON MECANICO--------------->
<h3>Acciones r√°pidas</h3>
<div class="d-flex gap-2 flex-wrap">
  <form method="post" action="{% url 'ot_mecanico_accion' numero_ot=ot.numero_ot accion='iniciar' %}">{% csrf_token %}
    <button class="btn btn-sm btn-primary" {% if ot.estado != 'PENDIENTE' %}disabled{% endif %}>Iniciar</button>
  </form>

  <form method="post" action="{% url 'ot_mecanico_accion' numero_ot=ot.numero_ot accion='reanudar' %}">{% csrf_token %}
    <button class="btn btn-sm btn-success" {% if ot.estado != 'PAUSADA' %}disabled{% endif %}>Reanudar</button>
  </form>

  <form method="post" action="{% url 'ot_mecanico_accion' numero_ot=ot.numero_ot accion='pausar' %}">{% csrf_token %}
    <input name="motivo" placeholder="Motivo de pausa" style="width:220px;">
    <button class="btn btn-sm btn-warning" {% if ot.estado != 'EN_PROCESO' %}disabled{% endif %}>Pausar</button>
  </form>

  <form method="post" action="{% url 'ot_mecanico_accion' numero_ot=ot.numero_ot accion='finalizar' %}">{% csrf_token %}
    <button class="btn btn-sm btn-secondary" {% if ot.estado not in 'EN_PROCESO,PAUSADA' %}disabled{% endif %}>Finalizar</button>
  </form>
</div>







<h3>Solicitar repuesto</h3>

{% if puede_solicitar_repuesto %}
  <form method="post" action="{% url 'ot_solicitar_repuesto' numero_ot=ot.numero_ot %}">
  {% csrf_token %}
  {{ form_solicitud_repuesto.repuesto }}
  {{ form_solicitud_repuesto.cantidad }}
  {{ form_solicitud_repuesto.nombre_proveedor }}
  {{ form_solicitud_repuesto.observaciones }}
  <button class="btn btn-primary btn-sm" type="submit">Solicitar</button>
</form>
{% endif %}


{# === FORMULARIO PARA SOLICITAR REPUESTOS (mec√°nico asignado o supervisor) === #}
{% if puede_solicitar_repuesto %}
<section class="card">
  <h3>Solicitar repuesto</h3>
  <form method="post" action="{% url 'ot_solicitar_repuesto' numero_ot=ot.numero_ot %}">
    {% csrf_token %}
    {{ form_solic_repuesto.repuesto }}
    {{ form_solic_repuesto.cantidad }}
    {{ form_solic_repuesto.observacion }}
    <button class="btn btn-primary btn-sm" type="submit">Solicitar</button>
  </form>
</section>
{% endif %}

{# === LISTA DE SOLICITUDES LOCALES (BD) visible para todos los que ven la OT) === #}
<section class="card">
  <h3>Solicitudes (local)</h3>
  <table class="table">
    <thead>
      <tr>
        <th>ID</th><th>Repuesto</th><th>Cant.</th><th>Estado</th><th>Creada por</th><th>Fecha</th>
        <th>Acci√≥n</th>
      </tr>
    </thead>
    <tbody>
      {% for s in solicitudes_locales %}
      <tr>
        <td>{{ s.id }}</td>
        <td>{{ s.repuesto.nombre }}</td>
        <td>{{ s.cantidad }}</td>
        <td>{{ s.estado }}</td>
        <td>{{ s.creado_por.nombre_completo }}</td>
        <td>{{ s.fecha_creacion|date:"d-m-Y H:i" }}</td>
        <td>
          {% if soy_supervisor and s.id and s.estado != "RECIBIDA" %}
            <a class="btn btn-sm"
               href="{% url 'ot_confirmar_entrega' numero_ot=ot.numero_ot solicitud_id=s.id %}">
              Confirmar entrega
            </a>
          {% else %}‚Äî{% endif %}
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="7">Sin solicitudes.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</section>











{% if soy_mecanico_asignado or soy_supervisor %}
<h3>Observaciones del mec√°nico</h3>
<textarea id="obs-mec" rows="5" class="form-control"
          placeholder="Escribe tus observaciones t√©cnicas...">{{ obs_mecanico_inicial }}</textarea>
<p id="obs-status" style="font-size:12px;color:#666;margin-top:4px;">‚Äî</p>

<script>
(function(){
  function getCookie(name){
    const v = document.cookie.split(';').map(s=>s.trim());
    for(const p of v){ if (p.startsWith(name + '=')) return decodeURIComponent(p.split('=')[1]); }
    return '';
  }
  const ta = document.getElementById('obs-mec');
  const status = document.getElementById('obs-status');
  if(!ta) return;
  let timer = null;

  function saveNow(){
    const form = new FormData();
    form.append('texto', ta.value);
    fetch("{% url 'ot_guardar_observaciones' numero_ot=ot.numero_ot %}", {
      method: 'POST',
      headers: {'X-CSRFToken': getCookie('csrftoken')},
      body: form
    }).then(r=>r.json()).then(j=>{
      status.textContent = j.ok ? 'Guardado ‚úì' : 'Error al guardar';
    }).catch(()=>{ status.textContent = 'Error de red'; });
  }

  function schedule(){
    status.textContent = 'Guardando...';
    clearTimeout(timer);
    timer = setTimeout(saveNow, 1000); // 1s tras dejar de tipear
  }

  ta.addEventListener('input', schedule);
  window.addEventListener('beforeunload', function(){
    if(timer){ clearTimeout(timer); saveNow(); }
  });
})();
</script>
{% endif %}





<h3>Tiempo en estado: <span id="timer-estado">‚Äì:‚Äì:‚Äì</span></h3>
<script>
(function(){
  const start = new Date("{{ inicio_estado_iso }}");
  const el = document.getElementById('timer-estado');
  if(!el || isNaN(start)) return;
  function two(n){ return (n<10?'0':'')+n; }
  function tick(){
    const diff = Date.now() - start.getTime();
    if (diff < 0){ el.textContent = "00:00:00"; return; }
    const s = Math.floor(diff/1000);
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    const ss = s%60;
    el.textContent = two(h)+":"+two(m)+":"+two(ss);
  }
  tick();
  setInterval(tick, 1000);
})();
</script>


{% if soy_mecanico_asignado or soy_supervisor %}
<h3>Checklist</h3>
<div class="card" style="padding:0.5rem;">
  <table class="table">
    <thead><tr><th>OK</th><th>√çtem</th><th>Obs / Resultado</th><th>Guardar</th></tr></thead>
    <tbody>
      {% for it in checklist %}
      <tr>
        <td>
          <input type="checkbox" data-code="{{ it.code }}" class="chk-ok" {% if it.estado and it.estado|slice:":2" == "OK" %}checked{% endif %}>
        </td>
        <td>{{ it.texto }}</td>
        <td>
          <input type="text" class="chk-obs" data-code="{{ it.code }}"
                 value="{% if it.estado and it.estado|slice:":2" != "OK" %}{{ it.estado|cut:'NO: ' }}{% endif %}">
        </td>
        <td>
          <button type="button" class="btn btn-sm btn-primary btn-chk-guardar" data-code="{{ it.code }}">Guardar</button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
(function(){
  function getCookie(name){
    const v = document.cookie.split(';').map(s=>s.trim());
    for(const p of v){ if (p.startsWith(name + '=')) return decodeURIComponent(p.split('=')[1]); }
    return '';
  }
  function post(code, ok, obs){
    const fd = new FormData();
    fd.append('code', code);
    fd.append('ok', ok ? '1' : '0');
    fd.append('obs', obs || '');
    return fetch("{% url 'ot_checklist_toggle' numero_ot=ot.numero_ot %}", {
      method: 'POST', headers: {'X-CSRFToken': getCookie('csrftoken')}, body: fd
    }).then(r=>r.json());
  }
  document.querySelectorAll('.btn-chk-guardar').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const code = btn.dataset.code;
      const ok = document.querySelector('.chk-ok[data-code="'+code+'"]').checked;
      const obs = document.querySelector('.chk-obs[data-code="'+code+'"]').value;
      post(code, ok, obs).then(j=>{ if(!j.ok) alert('Error guardando'); });
    });
  });
})();
</script>
{% endif %}





<th>Acci√≥n</th>
...
<td>
  {% if soy_supervisor and s.id and s.estado != "RECIBIDA" %}
    <a class="btn btn-sm" href="{% url 'ot_confirmar_entrega' numero_ot=ot.numero_ot solicitud_id=s.id %}">Confirmar entrega</a>
  {% else %}‚Äî{% endif %}
</td>




<!----------------------------->












<hr/>

<h3>Historial de estados</h3>
<table class="table table-sm">
  <thead>
    <tr>
      <th>Fecha</th>
      <th>De</th>
      <th>A</th>
      <th>Realizado por </th>
      <th>Motivo</th>
    </tr>
  </thead>
  <tbody>
    {% for log in logs %}
    <tr>
      <td>{{ log.fecha_cambio|date:"d-m-Y H:i" }}</td>
      <td>{{ log.estado_anterior|default:"‚Äî" }}</td>
      <td>{{ log.estado_nuevo }}</td>
      <td>{{ log.cambiado_por.nombre_completo }}</td>
      <td>{{ log.motivo_cambio|default:"‚Äî" }}</td>
    </tr>
    {% empty %}
    <tr><td colspan="5">Sin registros de cambios</td></tr>
    {% endfor %}
  </tbody>





  <h3>Adjuntos</h3>

{% if adjuntos %}
  <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(180px,1fr)); gap:12px;">
    {% for a in adjuntos %}
      <div class="card" style="padding:.5rem;">
        {% if a.tipo_archivo == "IMG" %}
          <a href="{{ a.ruta_archivo }}" target="_blank" title="{{ a.nombre_archivo }}">
            <img src="{{ a.ruta_archivo }}" alt="{{ a.nombre_archivo }}" style="width:100%; height:120px; object-fit:cover; border-radius:6px;">
          </a>
        {% elif a.tipo_archivo == "PDF" %}
          <div style="display:flex; flex-direction:column; gap:.35rem;">
            <span>üìÑ {{ a.nombre_archivo }}</span>
            <a class="btn btn-sm" href="{{ a.ruta_archivo }}" target="_blank">Ver PDF</a>
          </div>
        {% else %}
          <a href="{{ a.ruta_archivo }}" target="_blank">‚¨á {{ a.nombre_archivo }}</a>
        {% endif %}
        <div style="margin-top:.35rem; font-size:.8rem; color:#555;">
          Subido: {{ a.fecha_subida|date:"d-m-Y H:i" }}
        </div>
      </div>
    {% endfor %}
  </div>
{% else %}
  <p>No hay adjuntos a√∫n.</p>
{% endif %}

</table>


{% endblock %}
