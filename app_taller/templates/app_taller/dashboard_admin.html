{% extends "app_taller/base.html" %}

{% block content %}

<h2>Hola, {{ usuario_app.nombre_completo|default:request.user.get_username }} </h2>
<h2>Dashboard 路 Administrador</h2>
<p class="muted">Vista global del sistema y administraci贸n de cuentas.</p>

{# KPIs OTs #}
<section class="card">
  <h3>rdenes de Trabajo</h3>
  <div class="kpi-grid">
    <div class="kpi ok">
      <div class="kpi-label">OTs total</div>
      <div class="kpi-value">{{ kpi_ots.total }}</div>
    </div>
    <div class="kpi">
      <div class="kpi-label">En proceso</div>
      <div class="kpi-value">{{ kpi_ots.en_proceso }}</div>
    </div>
    <div class="kpi warn">
      <div class="kpi-label">Pendientes</div>
      <div class="kpi-value">{{ kpi_ots.pendientes }}</div>
    </div>
    <div class="kpi">
      <div class="kpi-label">Cerradas</div>
      <div class="kpi-value">{{ kpi_ots.cerradas }}</div>
    </div>
    <div class="kpi danger">
      <div class="kpi-label">Prioridad cr铆tica</div>
      <div class="kpi-value">{{ kpi_ots.criticas }}</div>
    </div>
  </div>
</section>

{# KPIs usuarios #}
<section class="card">
  <h3>Usuarios del sistema</h3>
  <div class="kpi-grid">
    <div class="kpi">
      <div class="kpi-label">Usuarios totales</div>
      <div class="kpi-value">{{ kpi_users.total }}</div>
    </div>
    <div class="kpi ok">
      <div class="kpi-label">Activos</div>
      <div class="kpi-value">{{ kpi_users.activos }}</div>
    </div>
    <div class="kpi warn">
      <div class="kpi-label">Inactivos</div>
      <div class="kpi-value">{{ kpi_users.inactivos }}</div>
    </div>
    <div class="kpi">
      <div class="kpi-label">Mec谩nicos</div>
      <div class="kpi-value">{{ kpi_users.mecanicos }}</div>
    </div>
    <div class="kpi">
      <div class="kpi-label">Supervisores</div>
      <div class="kpi-value">{{ kpi_users.supervisores }}</div>
    </div>
  </div>
</section>

<h2 style="margin-top:1.5rem;">Administraci贸n de usuarios</h2>

{# Barra de acciones: texto + botones #}
<div class="admin-actions-bar">
  <p class="muted admin-actions-text">
    Desde este panel puedes gestionar las cuentas del sistema y las cargas masivas.
  </p>
  <div class="admin-actions-buttons">
    <a href="{% url 'admin_usuarios_panel' %}" class="btn btn-primary btn-sm">
       Gesti贸n de Usuarios
    </a>

    <a href="{% url 'admin_excel_panel' %}" class="btn btn-sm">
       Importar / Exportar (Excel)
    </a>

    <a href="{% url 'admin_repuestos_panel' %}" class="btn btn-sm btn-primary">
      О Ver Repuestos
    </a>
  </div>
</div>

{# Grid principal: en desktop 2 columnas, en m贸vil 1 #}
<div class="admin-grid">
  <section class="card">
    <h3>Gesti贸n de usuarios</h3>

    <div class="tabla-wrapper">
      <table class="ot-table tabla-responsiva tabla-usuarios">
        <thead>
          <tr>
            <th>Nombre</th>
            <th>RUT</th>
            <th>Rol</th>
            <th>Email</th>
            <th>Estado</th>
            <th style="min-width:160px;">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for u in usuarios %}
          <tr>
            <td>{{ u.nombre_completo }}</td>
            <td>{{ u.rut }}</td>
            <td>{{ u.rol }}</td>
            <td>{{ u.email }}</td>
            <td>
              {% if u.activo %}
                <span class="badge state-en_proceso">Activo</span>
              {% else %}
                <span class="badge state-pausada">Inactivo</span>
              {% endif %}
            </td>
            <td>
              <div class="acciones-usuario">
                <form method="post" action="{% url 'admin_usuario_toggle_activo' u.id %}">
                  {% csrf_token %}
                  <button class="btn btn-xs" type="submit">
                    {% if u.activo %}Desactivar{% else %}Activar{% endif %}
                  </button>
                </form>

                <form method="post" action="{% url 'admin_usuario_reset_password' u.id %}">
                  {% csrf_token %}
                  <button class="btn btn-xs" type="submit">
                    Resetear clave
                  </button>
                </form>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="6" style="text-align:center;">No hay usuarios creados.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

  <section class="card">
    <div class="admin-ultimas-ots-header">
      <h3>ltimas OTs creadas</h3>
      <a class="btn btn-xs" href="{% url 'ot_list' %}">
         Listado OTs
      </a>
    </div>

    <div class="tabla-wrapper">
      <table class="table-compact tabla-responsiva">
        <thead>
          <tr>
            <th>N掳</th>
            <th>Patente</th>
            <th>Estado</th>
            <th>Prioridad</th>
            <th>F. Apertura</th>
          </tr>
        </thead>
        <tbody>
          {% for ot in ultimas_ots %}
          <tr onclick="location.href='{% url 'ot_detalle' numero_ot=ot.numero_ot %}'" style="cursor:pointer;">
            <td>#{{ ot.numero_ot }}</td>
            <td>{{ ot.vehiculo.patente }}</td>
            <td>{{ ot.get_estado_display }}</td>
            <td>{{ ot.get_prioridad_display }}</td>
            <td>{{ ot.fecha_apertura|date:"d-m-Y H:i" }}</td>
          </tr>
          {% empty %}
          <tr><td colspan="5">Sin registros.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
</div>

{% endblock %}
